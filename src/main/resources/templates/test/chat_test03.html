<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">	
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>CHAT TEST 02</title>
	<style>	
		*{
	    	margin: 0; padding: 0;
	    	box-sizing: border-box;
		}
		
		#chat-wrapper {
			position: fixed;
			bottom: 80px;
			right: 100px;
		}
		#chat-window-btn {
			height: 80px;
			width: 80px;
			
			border-radius: 100%;
			
			box-shadow: 5px 5px 5px lightgray, -2px -2px 5px lightgray, 5px -2px 5px lightgray, -2px 5px 5px lightgray;
			
			/*background-color: lightblue;*/
		}
		#chat-window {
			position: absolute;
			bottom: 100px;
			right: 0px;
			
			height: 600px;
			width: 400px;
			
			border-radius: 20px/20px;
			
			box-shadow: 5px 5px 30px lightgrey, -2px -2px 30px lightgrey, 5px -2px 30px lightgrey, -2px 5px 30px lightgrey;
			
			/*background-color: lightcoral;*/
		}
		#chat-list-empty {		
			display: flex;
			flex-direction: column;
			justify-content: center;
			align-items: center;
			
			height: 100%;
		}
		#cc-logo-empty {
			display: block;
			
			height: 150px;
			width: 150px;
			
			margin-bottom: 20px;
			
			object-fit: cover;
		}
		#chat-list-cont {
			height: 100%;
			width: 100%;

			padding-top: 10px;

			overflow: auto;
		}
        #chat-body-cont {
            width: 100%;
            height: 100%;
        }
        #chat-body-header {
            width: 100%;
            height: 50px;

            padding: 0 5px 0 5px;

            border-radius: 20px 20px 0 0;

            display: flex;
            flex-direction: row;
            align-content: stretch;
            align-items: center;

            background-color: lightblue;
        }
        #chat-body-inner-cont {
            width: 100%;
            height: 500px;
            
            display: flex;
            /* flex-direction: column-reverse; */
            flex-direction: column;

            overflow: auto;
        }
        /* 참조 https://codingbroker.tistory.com/66 */
        #chat-body-inner-cont::-webkit-scrollbar {
            width: 10px;
        }
        #chat-body-inner-cont::-webkit-scrollbar-thumb {
            background-color: lightcoral;
            border-radius: 20px;
            background-clip: padding-box;
            border: 2px solid transparent;
        }
        #chat-body-inner-cont::-webkit-scrollbar-track {
            /* background-color: lightcyan; */
        }
        #chat-body-input-cont {
            width: 100%;
            height: 50px;

            background-color: lightblue;

            border-radius: 0 0 20px 20px;
        }

        #quit-chat {
            margin-right: 5px;
        }

		.cc-list-element {
			height: 100px;
			width: 380px;

			margin: 0 auto;
			margin-bottom: 10px;

			border-radius: 15px/15px;

			background-color: lightsalmon;

			/* overflow: hidden; */
			/*
				inline-block 자식 못난놈들 여백 없애기
				https://rgy0409.tistory.com/4678 참조
				자식요소에서 글씨 쓰려면 아래 속성들을 초기화해줘야 함
				특히 fz
			*/
			font-size: 0;
			letter-spacing: 0;
			word-spacing: 0;
		}
		.cc-list-element>div:first-child {
			display: inline-block;
			height: 100px;
			width: 100px;
			margin-right: 10px;

			font-size: 16px;

			padding-top: 10px;
			padding-left: 10px;
		}
		.cc-list-element>div:last-child {
			display: inline-block;
			height: 100px;
			width: 270px;

			font-size: 16px;

			vertical-align: top;

			position: relative;

			padding-top: 10px;
		}
		.cc-list-element>div:first-child>img {
			display: block;
			height: 80px;
			width: 80px;

			border-radius: 10px/10px;

			object-fit: cover;
		}
		.cc-list-element>div:last-child>h4:first-child {
			/* margin-bottom: 5px; */
		}
		.cc-list-element>div:last-child>p:nth-child(2) {
			font-size: 12px;
			margin-bottom: 5px;
		}
		.cc-list-element>div:last-child>p:nth-child(3) {
			font-size: 14px;
			margin-bottom: 8px;
		}
		.cc-list-element>div:last-child>p:nth-child(4) {
			font-size: 10px;
		}
		.cc-list-element>div:last-child>div:last-child {
			position: absolute;
			right: 5px;
			bottom: 5px;

			width: 40px;
			height: 40px;

			border-radius: 100%;

			background-color: crimson;

			text-align: center;
			line-height: 40px;
			font-size: 25px;
			color: white;
		}

        .ccbody-left, .ccbody-right {
            min-width: 50px;
            max-width: 300px;
            min-height: 20px;
            max-height: fit-content;

			border-radius: 10px/10px;

            font-size: 16px;
            word-break: break-all;

            margin: 0 15px 15px 15px;
            padding: 5px 10px 5px 10px;

            flex-shrink: 0;

            background-color: lightsalmon;
        }
        .ccbody-left {
            margin-right: auto;
        }
        .ccbody-right {
            margin-left: auto;
            margin-right: 5px;
        }
        .ccbody-continue {
            margin-bottom: 5px;
        }
        .ccbody-btn {
            width: 40px;
            height: 40px;
            border: 0;
            /* background-color: transparent; */
        }
		
		.cc-hidden {
			display: none!important;
		}
	</style>
</head>
<body>
	<div id="chat-wrapper">
		<div id="chat-window-btn">채팅<br>이미지 여기에</div>
		<div id="chat-window" class="cc-hidden">
			<div id="chat-list-empty">
				<!-- 이미지 바꿔라 -->
				<img src="/images/layoutimg/logo.png" id="cc-logo-empty">
				<p>현재 입장해있는 채팅방이 없습니다</p>
			</div>
			<div id="chat-list-cont" class="cc-hidden">
				<!--아래와 같은 양식으로 채팅방 리스트 요소를 추가/수정한다
					CSS도 아래 양식대로 묶여있으니 꼭 지켜줘야 함
				<div id="cclistele-1" class="cc-list-element">
					<div>
						<img src="../../static/images/layoutimg/logo.png" alt="img001">
					</div>
					<div>
						<h4>패키지명 팔라우 바다여행</h4>
						<p>qwerty1234</p>
						<p>네 5박 6일 맞습니다</p>
						<p>5월 28일</p>
						<div>99..</div>
					</div>
				</div>
				<div id="cclistele-2" class="cc-list-element">
					<div>
						<img src="../../static/images/layoutimg/logo.png" alt="img002">
					</div>
					<div>
						<h4>팔라우 6박7일 하루빼고 바다만</h4>
						<p>qwerty1234</p>
						<p>진짜 6일동안 바다만 다녀요?</p>
						<p>5월 28일</p>
						<div class="cc-hidden">0</div>
					</div>
				</div>
				-->
			</div>
			<div id="chat-body-cont" class="cc-hidden">
                <div id="chat-body-header">
                    <input type="submit" value="나가기" id="quit-chat" class="ccbody-btn">
                    <h4 id="chat-body-title"></h4>
                </div>
				<div id="chat-body-inner-cont">
                </div>
                <div id="chat-body-input-cont">
                    <input type="text" id="input-chat">
                    <input type="submit" value="전송" id="submit-chat" class="ccbody-btn">
                </div>
			</div>
		</div>
	</div>
</body>
<script>
	/*================================================================================*/
	/*HTML 요소 전역변수*/
	//채팅창 버튼
	const CHAT_WINDOW_BTN = document.getElementById("chat-window-btn");
	//채팅창
	const CHAT_WINDOW = document.getElementById("chat-window");
	//채팅방 목록 empty 시 출력 요소
	const CHAT_LIST_EMPTY = document.getElementById("chat-list-empty");
	//채팅방 목록창
	const CHAT_LIST_CONT = document.getElementById("chat-list-cont");
	//채팅창
	const CHAT_BODY_CONT = document.getElementById("chat-body-cont");
	//채팅창 제목
	const CHAT_BODY_TITLE = document.getElementById("chat-body-title");

	/*================================================================================*/
	/*테스트*/
	let CHAT_LIST_VD = {};
	let CHAT_DETAIL_VD = {};

	let WORKER = null;

	window.addEventListener("load", function(e) {
		if(!!window.SharedWorker) {
			//공유워커 지원 브라우저
			WORKER = new SharedWorker("http://localhost:8080/js/chat/chatworkertemp.js", "tripfy-chatworker");

			WORKER.port.onmessage = (e) => {
				//공유워커에서 메세지 수신시
				//일단 콘솔로그만 해둠
				console.log("SharedWorder broadcasted data=" + e.data);
				console.log(e.data);
			};

			window.addEventListener("beforeunload", (e) => {
				WORKER.port.postMessage({
					action: "closePort"
				});
			});

			WORKER.port.start();
		} else {
			//공유워커 미지원 브라우저
			window.alert("아직도 IE를 쓰느냐");
			window.close();
		}
	});

	//한번에 로드할 채팅방 개수
	const CHAT_ROOM_LOAD_CNT = 10;

	//로드된 채팅방 개수
	let CHAT_ROOM_CNT = 0;

	/*================================================================================*/
	/*클릭이벤트 등록*/
	
	//채팅창 버튼
	CHAT_WINDOW_BTN.addEventListener("click", chatWindowBtnClick);

	/*================================================================================*/
	/*클릭이벤트*/

	//채팅창 버튼 클릭
	/*
		채팅창 열기 <-> 닫기
		이미 로드된 채팅창이 있을 경우 서버 요청을 하지 않음
	*/
	function chatWindowBtnClick(e) {
		if(CHAT_WINDOW.classList.contains("cc-hidden")) {
			CHAT_WINDOW.classList.remove("cc-hidden");
			if(CHAT_ROOM_CNT == 0) {
				//Ajax 호출
				ajaxGet("localhost:8080", "/chat", {
					start: CHAT_ROOM_CNT,
					end: CHAT_ROOM_CNT + CHAT_ROOM_LOAD_CNT
				})
				.then((data) => {
					updateChatListVD(data);
					printChatList();
				})
				.catch((error) => {
					console.log("err");
					console.log(error);
				});
			}
		} else {
			CHAT_WINDOW.classList.add("cc-hidden");
		}
	}

	/*================================================================================*/
	/*VD 처리*/

	//채팅방 VD 정리
	/*
		정렬 기준은 regdate
		최초 로드인 경우 key값 i를 0으로, 그 외의 경우 CHAT_ROOM_CNT를 기준으로 함
	*/
	function updateChatListVD(data) {
		let i = 0;
		if(CHAT_ROOM_CNT > 0) {
			let i = CHAT_ROOM_CNT - 1;
		}
		for(let val of data) {
			CHAT_LIST_VD[i] = val;
			i++
		}
		CHAT_ROOM_CNT += data.length;
	}

	/*================================================================================*/
	/*DOM 구현*/

	//채팅방 리스트 구현
	function printChatList() {
		if(CHAT_ROOM_CNT > 0) {
			for(let orderKey in CHAT_LIST_VD) {
				const vdRoomIdx = CHAT_LIST_VD[orderKey].roomidx;
				const listArr = Array.from(CHAT_LIST_CONT.children);

				let i = 0;
				for(; i < listArr.length; i++) {
					if(listArr[i].id === "cclistele-" + vdRoomIdx) {
						if(i != orderKey) {
							//요소 RD에 존재, RD/VD 위치 불일치
							//기본적으로는 타겟 다음 위치로 삽입
							if(orderKey < 1) {
								listArr[orderKey].insertAdjacentElement("beforebegin", listArr[i]);
							} else {
								listArr[orderKey - 1].insertAdjacentElement("afterend", listArr[i]);
							}
						}
						//요소 RD에 존재, RD/VD 위치 일치의 경우 요소를 움직이지 않는다

						//내부 요소 수정
						//일단 이미지는 건들지 않음
						adjustChatList(listArr[i], CHAT_LIST_VD[orderKey]);
					}
				}
				if(i === listArr.length) {
					//요소 RD에 존재하지 않음
					createCCListElement(CHAT_LIST_VD[orderKey]);
				}
			}
			CHAT_LIST_CONT.classList.remove("cc-hidden");
			CHAT_LIST_EMPTY.classList.add("cc-hidden");
		} else {
			CHAT_LIST_CONT.classList.add("cc-hidden");
			CHAT_LIST_EMPTY.classList.remove("cc-hidden");
		}
	}

	//채팅방 요소 내부 수정
	function adjustChatList(targetEle, dataObj) {
		const secInnerDiv = targetEle.children[1];

		//title
		if(secInnerDiv.children[0].innerHTML != dataObj.pkgname) {
			secInnerDit.children[0].innerHTML = dataObj.pkgname;
		}
		//userid - 마지막 송신자
		if(secInnerDiv.children[1].innerHTML != dataObj.userid) {
			secInnerDiv.children[1].innerHTML = dataObj.userid;
		}
		// - 마지막 메시지 내용
		if(secInnerDiv.children[2].innerHTML != dataObj.chatContent) {
			secInnerDiv.children[2].innerHTML = dataObj.chatContent;
		}
		//regdate
		if(secInnerDiv.children[3].innerHTML != dataObj.regdate) {
			secInnerDiv.children[3].innerHTML != dataObj.regdate;
		}
		//미수신 개수
		//는 일단 미정
		if(secInnerDiv.children[4].innerHTML != dataObj.uncheckedmsg) {
			secInnerDiv.children[4].innerHTML = dataObj.uncheckedmsg;
		}
		if(dataObj.uncheckedmsg == 0) {
			secInnerDiv.children[4].classList.add("cc-hidden");
		} else {
			secInnerDiv.children[4].classList.remove("cc-hidden");
		}
	}

	/*================================================================================*/
	/*DOM 요소 생성*/

	//채팅방 리스트 요소(div.cclistele-*) 생성 함수
	function createCCListElement(data) {

		console.log("enter createCCListElement()");

		//리스트 요소 생성, DOM에 추가, id/class 할당, 이벤트 할당
		const ccListElement = document.createElement("div");
		CHAT_LIST_CONT.appendChild(ccListElement);
		ccListElement.id = "cclistele-" + data.roomidx;
		ccListElement.classList.add("cc-list-element");
		// ccListElement.addEventListener("click", chatListEle_handlingClickEvent);

		//이미지 div/img 생성, DOM에 추가, 속성 부여
		const firDiv = document.createElement("div");
		ccListElement.appendChild(firDiv);
		const imgTag = document.createElement("img");
		firDiv.appendChild(imgTag);
		/*
			240529 현재는 ChatListPayloadDTO에서 이미지 관련값을 가져오지 않음
			따라서 지금은 이미지 링크를 static 이미지로 대체함
		*/
		imgTag.src = "/images/layoutimg/logo.png";
		imgTag.alt = data.pkgname + " 타이틀 이미지";

		//텍스트 div와 그 내부의 h4/p/div를 생성, DOM에 추가, 속성 부여
		/*
			각각
			패키지명, 상대 유저 userid, 마지막 메시지, 마지막 메시지 송신시각, 안 읽은 메시지 개수
			미확인 메시지개수는 0일 경우 출력하지 않으며 100개 이상인 경우 99..로 표시함

			일단 지금은 문자열이 길 경우 생략하는 기능은 없음 - 240529
		*/
		const secDiv = document.createElement("div");
		ccListElement.appendChild(secDiv);
		const h4Tag = document.createElement("h4");
		secDiv.appendChild(h4Tag);
		h4Tag.innerHTML = data.pkgname;
		const pTag1 = document.createElement("p");
		secDiv.appendChild(pTag1);
		pTag1.innerHTML = data.userid;
		const pTag2 = document.createElement("p");
		secDiv.appendChild(pTag2);
		pTag2.innerHTML = data.chatContent;
		const pTag3 = document.createElement("p");
		secDiv.appendChild(pTag3);
		pTag3.innerHTML = data.regdate;
		const unchkmsgDiv = document.createElement("div");
		secDiv.appendChild(unchkmsgDiv);
		if(data.uncheckedmsg > 0) {
			unchkmsgDiv.innerHTML = data.uncheckedmsg > 99 ? "99.." : data.uncheckedmsg;
		} else {
			unchkmsgDiv.innerHTML = "0";
			unchkmsgDiv.classList.add("cc-hidden");
		}
	}

	/*================================================================================*/
	/*AJAX*/
	/*
		대충 get 사용법
		ajaxGet("localhost:8080", "/chat", {
			//쿼리스트링에 넣을 키-값을 js 객체 형태로 삽입
			// 넣을 쿼리스트링이 없으면 생략 가능함
			"userid1": USER_ID,
			"userid2": "qwerty1234",
			"userid3": document.getElementById("simpleexampleelementid").value,
			...
		})
		.then((data) => {
			//대충 받은 데이터 사용하는 로직
		})
		.catch((error) => {
			//에러 발생시 로직
		});

		post 사용법
		ajaxPost("localhost:8080", "/chat", {
			//body에 넣을 키-값 value
			// js 객체 형태로 삽입
		}, {
			//header에 넣을 키-값 value
			// js 객체 형태로 삽입
			// 없으면 생략
		})
		.then((data) => {
			//받은 데이터 사용하는 로직
		})
		.catch((error) => {
			//에러 처리 로직
		});

		queryStrings, body, header는 js 객체 형태로 삽입
		반환되는 데이터는 무조건 JSON으로 수신 -> JS 객체화
	*/
	//GET
	async function ajaxGet(host, path, queryStrings={}) {
		let qs = "";
		if(Object.keys(queryStrings).length > 0) {
			qs += "?";
			for(let key in queryStrings) {
				qs += key + "=" + queryStrings[key] + "&";
			}
			qs = qs.replace(/\&$/, "");
		}

		const url = "http://" + host + path + qs;

		const res = await fetch(url);
		const data = await res.json();

		if(res.ok) {
			return data;
		} else {
			throw Error(res);
		}
	}
	//POST
	async function ajaxPost(host, path, body, header={}) {
		const url = "http://" + host + path;
		const options = {
			method: "POST",
			headers: {
				"Content-Type": "application/json",
				...headers,
			},
			body: JSON.stringify(body)
		};

		const res = await fetch(url, options);
		const data = await res.json();

		if(res.ok) {
			return data;
		} else {
			throw Error(res);
		}
	}
</script>
</html>