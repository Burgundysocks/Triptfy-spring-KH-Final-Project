<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>myinfo</title>
	<link rel="stylesheet" href="/css/user/myinfostyle.css">
</head>
<body>
	<th:block th:include="~{layout/header::header(${session.loginUser})}"></th:block>
	
	<div class="pfmdform">
		<form id="ptform" name="ptform" method="post" action="/user/changeimg" enctype="multipart/form-data">
			<p>프로필 사진 변경</p>
			<div id="profilecontainer">
				<label for="uploadfileform">
				<div id="profile">
					<img id="formprofileimg"  th:src="${'/user/thumbnail?sysname='+thumbnail}">
				</div>
				</label>
					
			</div>
			<div class="ptupload">
				<input type="hidden" name="changedfilename" value="">
				<input id="uploadfileform" type="file" name="thumbnail" onchange="chooseimg(this)" style="display: none;">
			</div>
			<div class="ptfaarea">
				<a th:href="'javascript:profilechagne(\''+${session.loginUser}+'\', \''+${thumbnail}+'\')'">변경완료</a>
				<a class="pfmdclose" href="javascript:closepfmdform()">나가기</a>
			</div>
		</form>
	</div>
	<section id="myinfowrap">
		<div id="profilewrap">
			<div id="profileupperwrap">
				<div id="profilecontainer">
					<div id="profile" class="pfmdopen">
						<img th:src="${'/user/thumbnail?sysname='+thumbnail}">
					</div>
				</div>
				<div id="infocontainer">
					<div class="nameguide">
						<p id="profname">[[${user.userid}]]</p>
						<p th:if="${session.guideNum!=0}" id="isguide"><img src="/images/userimg/guidebadge.png" alt=""></p>
						<div id="editbtn">
							<th:block th:if="${session.guideNum!=0}">
								<input type="button" value="여행후기작성" class="profmopenbtn" onclick="location.href='/user/after'">
								<div id="redalert"></div>
								<input type="button" value="가이드메뉴" class="profmopenbtn" onclick="location.href='/user/guide'">
							</th:block>
							<th:block th:unless="${session.guideNum!=0}">
								<input type="button" value="여행후기작성" class="profmopenbtn" onclick="location.href='/user/after'">
								<input type="button" value="가이드신청" class="profmopenbtn" onclick="location.href='/user/joinguide'">
							</th:block>
						</div>
					</div>
					<ul class="actcntlist">
						<li>
							<p>게시글</p>
							<p th:if="${list.size()>0}">[[${list.size()}]]</p>
							<p th:unless="${list.size()>0}">0</p>
						</li>
						<li>
							<p>댓글</p>
							<p>30</p>
						</li>
						<li>
							<p>좋아요</p>
							<p>3</p>
						</li>
					</ul>
					
					<div class="sogaebox">
						<div>
							<p>자기소개</p>
							<input type="button" name="open" id="openSogeEdit" class="hiddens sogaetriger">
							<input type="button" id="sogeWan" class="hiddens sogehide" onclick="sogesubmit()" value="완료">
							<input type="button" id="sogeCansle" class="hiddens sogehide sogaetriger" value="취소">
						</div>
						<form action="/user/sogae" method="get" name="sogaeform">
							<input type="hidden" name="_method" value="PUT"/>
							<textarea name="introduce" readonly>[[${user.introduce}]]</textarea>
						</form>
					</div>
				</div>
			</div>
			<div id="profilelowerwrap">
				<ul id="choicebtns">
					<li id="myboard" onclick="showMyBoards()" class="mypstselected-btn">내 게시글</li>
					<li id="joinpackage" onclick="showJoinPacks()">참여한 여행</li>
					<li style="display: none;"><input id="mypstshowtype" type="hidden" value="board"></li>
				</ul>
				<div id="mypostsection" class="mypstselected-body">
					<div id="mainmypost">
						<a th:if="${list != null and list.size > 0}" th:each="board:${list}"
							th:href="@{/board/get(boardnum=${board.boardnum})}">
							<div class="mypost">
								<div class="p_img">
									<img src="/images/boardimg/2.jpg" alt="">
								</div>
								<div class="post_write">
									<div class="pstguide">
										<img th:src="${'/user/thumbnail?sysname='+thumbnail}" alt="">
										<span>[[${board.userid}]]</span>
									</div>
									<div class="line"></div>
									<div class="post_title">[[${board.title}]]</div>
									<div class="post_preview">
										<ul class="showboardspecs">
											<li>
												<img src="/images/boardimg/location.png">
												<span>[[${board.viewcnt}]]</span>
											</li>
											<li>
												<img src="/images/boardimg/location.png">
												<span>[[${board.likecnt}]]</span>
											</li>
											<li>
												<img src="/images/boardimg/location.png">
												<span>[[${board.replycnt}]]</span>												
											</li>
										</ul>
									</div>
								</div>
							</div>
						</a>
					</div>
					<div id="mypagesarea" class="b_pagenation">
						<a class="" href="javascript:movepage(-1)">이전</a>
						<a class="" href="javascript:movepage(1)">다음</a>
					</div>
				</div>
			</div>
		</div>
		<div id="backbtnarea">
			<input type="button" value="돌아가기">
		</div>
	</section>
</body>


<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script th:inline="javascript">
	/*<![CDATA[*/
		const userthumbnail = [[${thumbnail}]];
		const userdir = [[${'/user/thumbnail?sysname='+thumbnail}]];
	/*]]>*/
</script>
<script>
	
	let orgval = $('textarea[name="introduce"]').val();
	$(".sogaetriger").click(function (){
		$(".hiddens").toggleClass("sogehide");
		$('textarea[name="introduce"]').prop('readonly',!$('textarea[name="introduce"]').prop('readonly'));
		
		if($(this).val()=="취소"){
			$('textarea[name="introduce"]').val(orgval);
		}
	})
	
	function sogesubmit(){
		const sogaeform = document.sogaeform;
		sogaeform.submit();
	}
	
	const pfmdform = document.querySelector('.pfmdform');
	const pfmdopen = document.querySelector('.pfmdopen');
	const pfmdclose = document.querySelector('.pfmdclose');
	
	pfmdopen.addEventListener('click', function () {
		pfmdform.style.display = 'block';
	});
	pfmdclose.addEventListener('click', function () {
		pfmdform.style.display = 'none';
	});
	
	
	
    const myboard = document.getElementById("myboard");
	const joinpackage = document.getElementById("joinpackage");
	
	const mypostsection = document.getElementById("mypostsection");
	
    function showMyBoards() {
		if($("#mypstshowtype").val()=='board'){
			console.log("이미 보드입니다");
			return;
		}
		
		let postsection = document.getElementById("mainmypost");
		
		$.ajax({
			url: "/user/myboard",
			method: "GET",
			
			success:function(datas){
				myboard.classList.toggle("mypstselected-btn");
				joinpackage.classList.toggle("mypstselected-btn");
				mypostsection.classList.toggle("mypstselected-body");
				$("#mypstshowtype").val("board");
				curpage=1;
				
				console.log(datas);
				
				if(datas.length==0||datas==null){
					postsection.innerHTML = "";
					let emptysignnode = document.createElement('img');
					emptysignnode.src = '/images/layoutimg/indeximg01.png';
					emptysignnode.className = 'centered-mpimg';
				} else {
					postsection.innerHTML = "";
					makeDOM("board", datas);
				}
			},
			
			error:function(){
				console.log("board 통신에러");
			}
		})
    }
	
	function showJoinPacks() {
		if($("#mypstshowtype").val()=='package'){
			console.log("이미 패키지입니다");
			return;
		}
		
		const postsection = document.getElementById("mainmypost");
		
		$.ajax({
			url: "/user/mypackage",
			method: "GET",
			
			success:function(datas){
				myboard.classList.toggle("mypstselected-btn");
				joinpackage.classList.toggle("mypstselected-btn");
				mypostsection.classList.toggle("mypstselected-body");
				$("#mypstshowtype").val("package");
				curpage=1;
				
				console.log(datas);
				
				if(datas.joinpackage==null||datas.joinpackage.length===0){
					postsection.innerHTML = "";
					let emptysignnode = document.createElement('img');
					emptysignnode.src = '/images/layoutimg/indeximg01.png';
					emptysignnode.className = 'centered-mpimg';
					
					postsection.appendChild(emptysignnode);
				} else {
					postsection.innerHTML = "";
					makeDOM("package", datas);
				}
			},
			
			error:function(){
				console.log("package 통신에러");				
			}
		})
	}
	
	function chooseimg(obj){
		console.log(obj.files[0]);
		let file = obj.files[0];
		if(!file.type.match("image.*")){
		     alert("이미지를 등록해야 합니다.")
		     return;
		}
		let reader = new FileReader();
		reader.readAsDataURL(file);
		
		reader.onload = function (e){ 
			console.log(e);
			$('#formprofileimg').attr("src", e.target.result);
		}
		 
	}
	function profilechagne(userid, sysname){
		const ptform = document.ptform;
		ptform.submit();
	}
	
	let curpage = 1;
	
	function movepage(diff){
		var movepage = curpage+diff;
		var loadtype = $("#mypstshowtype").val()
		
		if(movepage===0){
			alert("현재 1페이지 입니다.");
			return;
		}
		
		const postsection = document.getElementById("mainmypost");
		
		$.ajax({
			url:"/user/movepage?targetpage="+movepage+"&loadtype="+loadtype,
			method: "GET",
			
			success:function(datas) {
				console.log(datas);
				curpage = movepage;
				console.log("현재 페이지:"+curpage);
				
				if(datas.length===0 || datas.nodata!=null){
					postsection.innerHTML = "";
					let emptysignnode = document.createElement('img');
					emptysignnode.src = '/images/layoutimg/indeximg01.png';
					emptysignnode.className = 'centered-mpimg';
					
					postsection.appendChild(emptysignnode);
				} else {
					postsection.innerHTML = "";
					makeDOM(loadtype, datas);
				}
			},
			
			error:function(){
				console.log("통신 실패");
				alert("통신 실패");
			}
		});
	}
	
	function makeDOM(type, datas){
		var postsection = document.getElementById("mainmypost");
		if(type == 'board'){
			for(let i in datas){
				const board = datas[i];
				
				// <a> 요소 생성
				const a = document.createElement('a');
				a.href = '/board/get?boardnum='+board.boardnum;
				
				// <div class="mypost"> 요소 생성
				const mypostDiv = document.createElement('div');
				mypostDiv.className = 'mypost';
				
				// <div class="p_img"> 요소 생성 및 이미지 추가
				const pImgDiv = document.createElement('div');
				pImgDiv.className = 'p_img';
				const img1 = document.createElement('img');
				img1.src = '/images/boardimg/2.jpg';
				img1.alt = '';
				pImgDiv.appendChild(img1);
				
				// <div class="post_write"> 요소 생성
				const postWriteDiv = document.createElement('div');
				postWriteDiv.className = 'post_write';
				
				// <div class="pstguide"> 요소 생성 및 내용 추가
				const pstGuideDiv = document.createElement('div');
				pstGuideDiv.className = 'pstguide';
				const img2 = document.createElement('img');
				img2.src = userdir;
				img2.alt = '';
				const span1 = document.createElement('span');
				span1.textContent = board.userid;
				pstGuideDiv.appendChild(img2);
				pstGuideDiv.appendChild(span1);
				
				// <div class="line"> 요소 생성
				const lineDiv = document.createElement('div');
				lineDiv.className = 'line';
				
				// <div class="post_title"> 요소 생성 및 내용 추가
				const postTitleDiv = document.createElement('div');
				postTitleDiv.className = 'post_title';
				postTitleDiv.textContent = board.title;
				
				// <div class="post_preview"> 요소 생성
				const postPreviewDiv = document.createElement('div');
				postPreviewDiv.className = 'post_preview';
				
				// <ul class="showboardspecs"> 요소 생성 및 내용 추가
				const ul = document.createElement('ul');
				ul.className = 'showboardspecs';
				
				const createLi = (imgSrc, textContent) => {
				    const li = document.createElement('li');
				    const img = document.createElement('img');
				    img.src = imgSrc;
				    const span = document.createElement('span');
				    span.textContent = textContent;
				    li.appendChild(img);
				    li.appendChild(span);
				    return li;
				};
				
				ul.appendChild(createLi('/images/boardimg/location.png', board.viewcnt));
				ul.appendChild(createLi('/images/boardimg/location.png', board.likecnt));
				ul.appendChild(createLi('/images/boardimg/location.png', board.replycnt));
				
				postPreviewDiv.appendChild(ul);
				
				// 요소들을 조립
				postWriteDiv.appendChild(pstGuideDiv);
				postWriteDiv.appendChild(lineDiv);
				postWriteDiv.appendChild(postTitleDiv);
				postWriteDiv.appendChild(postPreviewDiv);
				
				mypostDiv.appendChild(pImgDiv);
				mypostDiv.appendChild(postWriteDiv);
				
				a.appendChild(mypostDiv);
				
				// 부모 div에 최종 요소 추가
				postsection.appendChild(a);
			}
		} else if(type=="package"){
			for(let i in datas.joinpackage){
				// 최상위 div 요소 생성
				const packmyaDiv = document.createElement('div');
				packmyaDiv.className = 'packmya';
				
				// package link wrap div 생성
				const packagelinkwrapDiv = document.createElement('div');
				packagelinkwrapDiv.className = 'packagelinkwrap';
				packagelinkwrapDiv.setAttribute('onclick', "location.href='/package/pget?packagenum="+datas.joinpackage[i].packagenum+"'");
				
				// my package thu div 생성
				const mypackagethuDiv = document.createElement('div');
				mypackagethuDiv.className = 'mypackagethu';
				
				// 이미지 생성
				const img = document.createElement('img');
				img.src = '/images/packageimg/384878.jpg';
				img.alt = '';
				img.className = 'packstampimgwidth';
				
				// 이미지 div에 추가
				mypackagethuDiv.appendChild(img);
				
				// my package content div 생성
				const mypackagecontDiv = document.createElement('div');
				mypackagecontDiv.className = 'mypackagecont';
				
				// package title div 생성
				const mypacktitDiv = document.createElement('div');
				mypacktitDiv.className = 'mypacktit';
				
				// 패키지 이름 p 요소 생성
				const pTitle = document.createElement('p');
				pTitle.textContent = datas.joinpackage[i].packageTitle;
				
				// span 요소 생성
				const span = document.createElement('span');
				span.id = 'ischiso';
				if(datas.myreservation[i].isDelete == 1){
					span.innerHTML = '&nbsp;&nbsp;취소진행중';
				} else{
					span.innerHTML = '&nbsp;&nbsp;취소진행중';
					span.className = 'chisojungtoggle';
				}
				
				// p 요소에 span 추가
				pTitle.appendChild(span);
				
				// 링크 요소 생성
				const aLink = document.createElement('a');
				aLink.href = '/user/receipt?packagenum='+datas.joinpackage[i].packagenum;
				aLink.textContent = '내역확인';
				
				// title div에 p와 링크 추가
				mypacktitDiv.appendChild(pTitle);
				mypacktitDiv.appendChild(aLink);
				
				// package information div 생성
				const mypackinformationDiv = document.createElement('div');
				mypackinformationDiv.className = 'mypackinformation';
				
				// 성인, 어린이 정보 p 요소 생성
				const pInfo1 = document.createElement('p');
				pInfo1.innerHTML = '성인: '+datas.myreservation[i].adultCnt+'명, 어린이: '+datas.myreservation[i].childCnt+'명 <span style="font-weight: bold;">￦'+datas	.myreservation[i].price+'</span>';
				
				// 날짜 정보 p 요소 생성
				const pInfo2 = document.createElement('p');
				pInfo2.textContent = datas.joinpackage[i].startdate+" ~ "+datas.joinpackage[i].enddate;
				
				// 정보 div에 p 요소 추가
				mypackinformationDiv.appendChild(pInfo1);
				mypackinformationDiv.appendChild(pInfo2);
				
				// content div에 title div와 information div 추가
				mypackagecontDiv.appendChild(mypacktitDiv);
				mypackagecontDiv.appendChild(mypackinformationDiv);
				
				// my package stamp div 생성
				const mypackagestampDiv = document.createElement('div');
				mypackagestampDiv.className = 'mypackagestamp';
				
				var today = new Date();
				var startdate = new Date(datas.joinpackage[i].startdate);
				var enddate = new Date(datas.joinpackage[i].enddate);
				// 스탬프 이미지 생성
				const stampImg = document.createElement('img');
				stampImg.className = 'packstampimg';
				if(datas.myreservation[i].isDelete == 2){
					stampImg.src = '/images/userimg/packagecansle.png';					
				} else if(datas.myreservation[i].isDelete == 1){
					stampImg.src = '/images/userimg/packagecansleing.png'
				} else {
					if(today>=enddate){
						stampImg.src = '/images/userimg/packagewan.png';						
					} else {
						stampImg.src = '/images/userimg/packageready.png';						
					}
				}
				
				// 스탬프 div에 이미지 추가
				mypackagestampDiv.appendChild(stampImg);
				
				// link wrap div에 thu, content, stamp div 추가
				packagelinkwrapDiv.appendChild(mypackagethuDiv);
				packagelinkwrapDiv.appendChild(mypackagecontDiv);
				packagelinkwrapDiv.appendChild(mypackagestampDiv);
				
				// 최상위 div에 link wrap div 추가
				packmyaDiv.appendChild(packagelinkwrapDiv);
				
				// 포스트섹션에 추가
				postsection.appendChild(packmyaDiv);
			}
		} else {
			console.log("잘못된 타입입니다.");
			return;
		}
	}	
</script>
</html>