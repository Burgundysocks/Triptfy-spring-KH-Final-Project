<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="/css/package/pget.css">
</head>
<body>
	<div id="hiddenData" style="display: none;" th:if="${#lists.size(reserve) > 0}" th:data-maxcnt="${package.maxcnt}" th:data-reservedcnt="${reserve[0].currentCount}"></div>
    <th:block th:include="~{layout/header::header(${session.loginUser})}"></th:block>
    <div id="wrap" class="get">
        <div class="body_container">
            <div class="packageinfo">
                <div class="pthumbnail">
                    <th:block th:each="file : ${files}">
                        <img th:src="${'/package/thumbnail?systemname=' + file.pfSysname}" alt="">
                    </th:block>
                </div>
                <div class="pinfo">
                    <div class="p_info">
                        <div class="p_header">
                            <div class="p_title">
                                <h3>[[${package.packageTitle}]]</h3>
                            </div>
							
							<div th:if="${package.guidenum == session.guideNum}" >
							<div class="modidelete">
                                <button><a th:href="@{/package/pmodify(packagenum=${package.packagenum})}">수정</a></button>
                                <button><a th:href="@{/package/remove(packagenum=${package.packagenum})}">삭제</a></button>
                            </div>
							</div>
                        </div>
                        <hr>
                        <div class="p_con">
                            <div class="paydetail">
                                <div class="adultchild">
                                    <div class="ac_head">
                                        <h3>인원선택 (필수)</h3>
                                    </div>
                                    <hr>
                                    <div class="ac_con">
                                        <div class="adult">
                                            <div class="adult_info">
                                                <h3>성인</h3>
                                                <p>[[${package.adultPrice}]] 원</p>
                                            </div>
                                            <div class="adult_cnt">
                                                <input type='button' onclick='count("minus")' value='-'/>
                                                <div id='result'>0</div>
                                                <input type='button' onclick='count("plus")' value='+'/>
                                            </div>
                                        </div>
                                        <div class="child">
                                            <div class="child_info">
                                                <h3>아이</h3>
                                                <p>[[${package.childPrice}]] 원</p>
                                            </div>
                                            <div class="child_cnt">
                                                <input type='button' onclick='count_child("minus")' value='-'/>
                                                <div id='result_child'>0</div>
                                                <input type='button' onclick='count_child("plus")' value='+'/>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="paybutton">
                                        <form id="paymentForm" action="pay" method="get">
                                            <input type="hidden" name="packagenum" id="packagenum" value=""> 
                                            <input type="hidden" name="adultCount" id="adultCount" value="0">
                                            <input type="hidden" name="childCount" id="childCount" value="0">
                                            <button type="button" onclick="submitPaymentForm()">결제하기</button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div> 
            </div>
        </div>
       
		<div class="moreinfo">
		    <div class="mi_container">
		        <div class="mi_header">
		            <div class="mi_menu">
		                <div class="menu1" id="menu1">여행소개</div> 
		                <div class="menu2" id="menu2">유의사항</div>
		                <div class="menu3" id="menu3">가이드리뷰</div>
		            </div>
		        </div>
		        <div class="mi_con">
		            <div class="menu1get content" id="menu1get">
		                [[${package.packageContent}]]
		            </div>
		            <div class="menu2get content" id="menu2get" style="display:none;">
		                <img src="/images/packageimg/warning.png">
		            </div>
					<div class="menu3get content" id="menu3get" style="display:none;">			    
					    <div th:if="${review != null and #lists.size(review) > 0 and review[0].guidenum == package.guidenum}">
					        <div th:each="review : ${review}" class="review">
					            <div class="userprofile">
									<img th:src="${'/package/thumbnail?systemname=' + review.userImages[0].sysname}">
					                <p><strong>[[${review.userid}]]</strong></p>
					            </div>
					            <div class="reviewcontent">[[${review.contents}]]</div>
					        </div>
					    </div>
					</div>
		        </div>
		    </div>
		    <div class="pay_container">
		        <div class="mapcon">
		            <div class="maphead">
		                <h3>[[${package.regionname}]]</h3>
		            </div>
		        
		            <div class="map">
						<div id="map"></div>
		            </div>
		           
		            <div class="mapfoot">
		                <a th:href="@{'/package/tlget?packagenum=' + ${package.packagenum}}">상세보기 ></a>
		            </div>
		        </div>
		    </div>
		</div>
    </div>
</body>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAClH3Zck8wh1CdEBWohj2_PxG1HZsSmEg&libraries=places,geometry"></script>
<script>
	const mapElement = document.getElementById('map');
	const defaultLocationName = '[[${package.regionname}]]';
	const zoomScope = 10;  // Replace with appropriate zoom level
	
	const geocoder = new google.maps.Geocoder();
	
	const hiddenData = document.getElementById('hiddenData');
	const maxCnt = parseInt(hiddenData.dataset.maxcnt);
	console.log(maxCnt);
	const reservedCnt = hiddenData.dataset.reservedcnt ? parseInt(hiddenData.dataset.reservedcnt) : 0;
	console.log(reservedCnt);
	
	document.addEventListener("DOMContentLoaded", function() {

		const remainingSeats = maxCnt - reservedCnt;
		    if (remainingSeats <= 0) {
		        // 수용 가능한 자리가 없는 경우
		        disablePaymentButton();
		    } else {
		        // 수용 가능한 자리가 있는 경우에는 버튼을 활성화합니다.
		        const payButton = document.querySelector('.paybutton button');
		        payButton.disabled = false;
		        payButton.style.backgroundColor = ''; // 기본 스타일로 변경
		        payButton.innerText = '결제하기';
		        payButton.addEventListener('click', function(event) {
		            submitPaymentForm();
		        });
			}
		
		function disablePaymentButton() {
		    const payButton = document.querySelector('.paybutton button');
		    payButton.disabled = true;
		    payButton.style.backgroundColor = 'grey'; // 원하는 스타일로 변경 가능
		    payButton.innerText = '수용 가능한 인원이 없습니다';
		}

		
		
		
		console.log(defaultLocationName);
		console.log(zoomScope);
	    geocoder.geocode({ 'address': defaultLocationName }, function(results, status) {
	        if (status === 'OK') {
	            const mapOptions = {
	                zoom: zoomScope,
	                center: results[0].geometry.location,
	                mapTypeId: google.maps.MapTypeId.ROADMAP,
	                disableDefaultUI: true
	            };
	            
	            const map = new google.maps.Map(mapElement, mapOptions);
	            const marker = new google.maps.Marker({
	                position: results[0].geometry.location,
	                map: map
	            });
	        } else {
	            alert('Geocode was not successful for the following reason: ' + status);
	        }
	    });
	});
		
    function count(type) {
        const resultElement = document.getElementById('result');
        let number = resultElement.innerText;

        if (type === 'plus') {
            number = parseInt(number) + 1;
        } else if (type === 'minus' && number > 0) {
            number = parseInt(number) - 1;
        }

        resultElement.innerText = number;
    }

    function count_child(type) {
        const resultElement = document.getElementById('result_child');
        let number = resultElement.innerText;

        if (type === 'plus') {
            number = parseInt(number) + 1;
        } else if (type === 'minus' && number > 0) {
            number = parseInt(number) - 1;
        }

        resultElement.innerText = number;
    }

	function submitPaymentForm() {
	    // 성인 및 아이 수를 가져와서 폼 필드에 설정
	    const adultCount = parseInt(document.getElementById('result').innerText);
	    const childCount = parseInt(document.getElementById('result_child').innerText);
	    const totalGuests = adultCount + childCount;
		const remainConfirm = maxCnt - reservedCnt - totalGuests;
	    if (totalGuests === 0) {
	        alert('최소 1명 이상의 인원을 선택해주세요.');
	        return; 
	    }
		else if(remainConfirm < 0){
			alert("예약 가능 인원을 초과하였습니다.");
			return;
		}
	
	    document.getElementById('adultCount').value = adultCount;
	    document.getElementById('childCount').value = childCount;
	    
	    // packagenum 값을 URL에서 가져오기
	    const urlParams = new URLSearchParams(window.location.search);
	    const packagenum = urlParams.get('packagenum');
	    document.getElementById('packagenum').value = packagenum;
	    
	    // 폼 제출
	    document.getElementById('paymentForm').submit();
	}
	
	document.addEventListener("DOMContentLoaded", function() {
	        // 메뉴 아이템을 변수에 저장
	        const menu1 = document.getElementById('menu1');
	        const menu2 = document.getElementById('menu2');
	        const menu3 = document.getElementById('menu3');
	
	        // 콘텐츠 아이템을 변수에 저장
	        const menu1get = document.getElementById('menu1get');
	        const menu2get = document.getElementById('menu2get');
	        const menu3get = document.getElementById('menu3get');
	
	        // 모든 콘텐츠를 숨기는 함수
	        function hideAllContents() {
	            menu1get.style.display = 'none';
	            menu2get.style.display = 'none';
	            menu3get.style.display = 'none';
	        }
	
	        // 모든 메뉴에서 active 클래스를 제거하는 함수
	        function removeActiveClass() {
	            menu1.classList.remove('menuOn');
	            menu2.classList.remove('menuOn');
	            menu3.classList.remove('menuOn');
	        }
	
	        // 각각의 메뉴 클릭 이벤트 리스너 추가
	        menu1.addEventListener('click', function() {
	            hideAllContents();
	            removeActiveClass();
	            menu1get.style.display = 'block';
	            menu1.classList.add('menuOn');
	        });
	
	        menu2.addEventListener('click', function() {
	            hideAllContents();
	            removeActiveClass();
	            menu2get.style.display = 'block';
	            menu2.classList.add('menuOn');
	        });
	
	        menu3.addEventListener('click', function() {
	            hideAllContents();
	            removeActiveClass();
	            menu3get.style.display = 'block';
	            menu3.classList.add('menuOn');
	        });
	    });
</script>
</html>
